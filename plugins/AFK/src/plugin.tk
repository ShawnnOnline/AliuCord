package com.shawnn.plugins

import com.aliucord.*
import com.aliucord.annotations.AliucordPlugin
import com.aliucord.entities.Plugin
import com.aliucord.patcher.PreHook
import com.discord.api.message.Message
import com.discord.utilities.rest.RestAPI
import com.discord.utilities.locale.LocaleManager
import com.discord.stores.StoreStream

@AliucordPlugin
class PluginAFK : Plugin() {

    private var afk = false

    private fun toggleMessage(lang: String): String {
        return when (lang) {
            "fr" -> if (afk) "Mode AFK activÃ©." else "Mode AFK dÃ©sactivÃ©."
            "es" -> if (afk) "Modo AFK activado." else "Modo AFK desactivado."
            "de" -> if (afk) "AFK-Modus aktiviert." else "AFK-Modus deaktiviert."
            "it" -> if (afk) "ModalitÃ  AFK attivata." else "ModalitÃ  AFK disattivata."
            else -> if (afk) "AFK mode enabled." else "AFK mode disabled."
        }
    }

    private fun afkReply(lang: String): String {
        return when (lang) {
            "fr" -> "Je suis AFK, rappelle moi plus tard, en attendant, mange une pizza ðŸ•ðŸ˜‹ !"
            "es" -> "Estoy AFK, recuÃ©rdame mÃ¡s tarde, mientras tanto come una pizza ðŸ•ðŸ˜‹ !"
            "de" -> "Ich bin AFK, erinnere mich spÃ¤ter, iss inzwischen eine Pizza ðŸ•ðŸ˜‹ !"
            "it" -> "Sono AFK, ricordami piÃ¹ tardi, nel frattempo mangia una pizza ðŸ•ðŸ˜‹ !"
            else -> "I'm AFK, remind me later, meanwhile eat a pizza ðŸ•ðŸ˜‹ !"
        }
    }

    override fun start(ctx: PluginContext) {

        commands.registerCommand("afk", null) {
            afk = !afk
            val lang = LocaleManager.getLocale().language
            CommandResult(toggleMessage(lang))
        }

        patcher.patch(
            com.discord.stores.StoreMessages::class.java.getDeclaredMethod(
                "handleIncomingMessage",
                Message::class.java
            ),
            PreHook { p ->
                if (!afk) return@PreHook
                val m = p.args[0] as Message
                val me = StoreStream.getUsers().me.id
                val mention = m.mentions.any { it.id == me }
                val dm = StoreStream.getChannels().privateChannelIds.contains(m.channelId)
                if (!mention && !dm) return@PreHook
                val lang = LocaleManager.getLocale().language
                RestAPI.getApi().sendMessage(
                    m.channelId,
                    afkReply(lang),
                    null
                ).subscribe({})
            }
        )
    }

    override fun stop(ctx: PluginContext) {
        patcher.unpatchAll()
        commands.unregisterAll()
    }
}
